var TURTLESIMJS=TURTLESIMJS||new Object;TURTLESIMJS.TURTLE_IMAGES=["img/box-turtle.png","img/diamondback.png","img/electric.png","img/fuerte.png","img/groovy.png","img/hydro.png","img/robot-turtle.png","img/sea-turtle.png","img/turtle.png"],TURTLESIMJS.DEFAULT_BG="#4556FF",TURTLESIMJS.CANVAS={height:11,width:11},TURTLESIMJS.TurtleSim=function(a){var b=this;return a=a||{},b.ros=a.ros,b.context=a.context,void 0===b.ros||void 0===b.context?(console.error("invalid options"),void 0):(this.keyControl=a.keyControl||!1,this.fill=a.fill||TURTLESIMJS.DEFAULT_BG,this.turtleList=new Object,this.turtle=null,this.keyControl&&(document.onkeydown=function(a){var c=a.keyCode||a.which,d={left:37,up:38,right:39,down:40};switch(c){case d.up:b.turtle.moveForward();break;case d.down:b.turtle.moveBackward();break;case d.left:b.turtle.moveLeft();break;case d.right:b.turtle.moveRight()}}),this.updateInterval(a.interval||100),void 0)},TURTLESIMJS.TurtleSim.prototype.updateInterval=function(a){return setInterval(this.update.bind(this),a),this},TURTLESIMJS.TurtleSim.prototype.update=function(){for(var b in this.turtleList)this.turtleList[b].update();this.draw()},TURTLESIMJS.TurtleSim.prototype.draw=function(){this.context.fillStyle=this.fill,this.context.fillRect(0,0,this.context.canvas.width,this.context.canvas.height);var a=this.context.fillStyle.match(/^#([0-9a-f]{6})$/i)[1];if(a&&a!=this.fill){this.fill=a;var b=new ROSLIB.Param({ros:this.ros,name:"background_r"});b.set(parseInt(a.substr(0,2),16));var c=new ROSLIB.Param({ros:this.ros,name:"background_g"});c.set(parseInt(a.substr(2,2),16));var d=new ROSLIB.Param({ros:this.ros,name:"background_b"});d.set(parseInt(a.substr(4,2),16))}for(var e in this.turtleList)this.turtleList[e].draw();return this},TURTLESIMJS.TurtleSim.prototype.spawnTurtle=function(a){if(this.hasTurtle(a.name))return console.error("invalid name"),void 0;var b=this;a=a||{};var c={x:a.x||b.context.canvas.width/2,y:a.y||b.context.canvas.height/2,theta:a.theta||0};return b.turtleList[a.name]=new TURTLESIMJS.Turtle({ros:b.ros,context:b.context,name:a.name,pen:a.pen,pose:c,img:a.img}),b.turtle=b.turtleList[a.name],b},TURTLESIMJS.TurtleSim.prototype.hasTurtle=function(a){return void 0!==this.turtleList[a]},TURTLESIMJS.TurtleSim.prototype.onClear=function(){this.fill=TURTLESIMJS.DEFAULT_BG,this.draw()},TURTLESIMJS.TurtleSim.prototype.onReset=function(){var a=this;this.fill=TURTLESIMJS.DEFAULT_BG;for(var b in this.turtleList)this.turtleList[b].pose.x=a.context.canvas.width/2,this.turtleList[b].pose.y=a.context.canvas.height/2,this.turtleList[b].pose.theta=0;this.draw()},TURTLESIMJS.TurtleSim.prototype.onKill=function(a){a in this.turtleList&&(delete this.turtleList[a],this.draw())},TURTLESIMJS.DEFAULT_PEN={color:"#b3b8ff",width:"3",off:!1},TURTLESIMJS.IMAGE_MAX={width:45,height:45},TURTLESIMJS.Turtle=function(a){var b=this;return a=a||{},b.ros=a.ros,b.context=a.context,void 0===b.ros||void 0===b.context?(console.error("invalid"),void 0):(b.name=a.name,b.pen=a.pen||TURTLESIMJS.DEFAULT_PEN,b.traj=new Array,b.cmd_time=void 0,b.last_time=new Date,b.pose=new ROSLIB.Message({x:a.pose.x||b.context.canvas.width/2,y:a.pose.y||b.context.canvas.height/2,theta:a.pose.theta||0,linear_velocity:a.pose.linear_velocity||0,angular_velocity:a.pose.angular_velocity||0}),b.velTopic=new ROSLIB.Topic({ros:b.ros,name:"/"+b.name+"/cmd_vel",messageType:"geometry_msgs/Twist"}),b.velTopic.subscribe(b.onVel.bind(b)),b.image=new Image,b.image.src=a.img||TURTLESIMJS.TURTLE_IMAGES[Math.floor(Math.random()*TURTLESIMJS.TURTLE_IMAGES.length)],b.image.width>TURTLESIMJS.IMAGE_MAX.width&&(b.image.height*=TURTLESIMJS.IMAGE_MAX.width/b.image.width,b.image.width=TURTLESIMJS.IMAGE_MAX.width),b.image.height>TURTLESIMJS.IMAGE_MAX.height&&(b.image.width*=TURTLESIMJS.IMAGE_MAX.height/b.image.height,b.image.height=TURTLESIMJS.IMAGE_MAX.height),0==b.image.height&&(b.image.height=TURTLESIMJS.IMAGE_MAX.height),0==b.image.width&&(b.image.width=TURTLESIMJS.IMAGE_MAX.width),void 0)},TURTLESIMJS.Turtle.prototype.update=function(){var a=this;new Date-a.cmd_time>1e3&&(a.pose.linear_velocity=0,a.pose.angular_velocity=0);var b=(new Date-this.last_time)/1e3;this.last_time=new Date,a.pose.theta=(a.pose.theta+a.pose.angular_velocity*b)%(2*Math.PI),a.pose.x+=Math.sin(this.pose.theta+Math.PI/2)*this.pose.linear_velocity*b*this.context.canvas.width/TURTLESIMJS.CANVAS.width,a.pose.y+=Math.cos(this.pose.theta+Math.PI/2)*this.pose.linear_velocity*b*this.context.canvas.height/TURTLESIMJS.CANVAS.height,this.pose.x=Math.min(Math.max(this.pose.x,0),this.context.canvas.width),this.pose.y=Math.min(Math.max(this.pose.y,0),this.context.canvas.height);var c=new ROSLIB.Topic({ros:this.ros,name:"/"+this.name+"/pose",messageType:"turtlesim/Pose"});c.publish(this.pose)},TURTLESIMJS.Turtle.prototype.draw=function(){var a=this;a.context.save(),a.context.beginPath();for(var b=1;b<a.traj.length;++b)a.context.moveTo(a.traj[b-1].x,a.traj[b-1].y),a.context.lineTo(a.traj[b].x,a.traj[b].y);if(!a.pen.off){var c=JSON.parse(JSON.stringify(a.pose)),d=a.traj.length>0?a.traj[a.traj.length-1]:void 0;0==a.traj.length?a.traj.push(c):(d.x!=a.pose.x||d.y!=a.pose.y)&&(a.context.moveTo(d.x,d.y),a.context.lineTo(a.pose.x,a.pose.y),a.traj.push(c))}a.context.strokeStyle=a.pen.color,a.context.stroke();var e=a.pose.x,f=a.pose.y,g=a.image.width,h=a.image.height;a.context.translate(e,f),a.context.rotate(-a.pose.theta+Math.PI/2),a.context.drawImage(a.image,-(g/2),-(h/2),g,h),a.context.restore()},TURTLESIMJS.Turtle.prototype.onVel=function(a){var b=this;b.pose.linear_velocity=a.linear.x,b.pose.angular_velocity=a.angular.z,b.cmd_time=new Date},TURTLESIMJS.Turtle.prototype.moveForward=function(){var a=new ROSLIB.Message({linear:{x:2,y:0,z:0},angular:{x:0,y:0,z:0}});this.velTopic.publish(a)},TURTLESIMJS.Turtle.prototype.moveBackward=function(){var a=new ROSLIB.Message({linear:{x:-2,y:0,z:0},angular:{x:0,y:0,z:0}});this.velTopic.publish(a)},TURTLESIMJS.Turtle.prototype.moveRight=function(){var a=new ROSLIB.Message({linear:{x:0,y:0,z:0},angular:{x:0,y:0,z:-2}});this.velTopic.publish(a)},TURTLESIMJS.Turtle.prototype.moveLeft=function(){var a=new ROSLIB.Message({linear:{x:0,y:0,z:0},angular:{x:0,y:0,z:2}});this.velTopic.publish(a)},TURTLESIMJS.Turtle.prototype.onSetPen=function(a,b,c){this.pen.color=a||this.pen.color,this.pen.width=b||this.pen.width,this.pen.off=void 0!==c?c:this.pen.off},TURTLESIMJS.Turtle.prototype.onTeleportAbsolute=function(a,b,c){this.pose.x=void 0!==a?a:this.pose.x,this.pose.y=void 0!==b?b:this.pose.y,this.pose.theta=void 0!==c?c:this.pose.theta,this.update()},TURTLESIMJS.Turtle.prototype.onTeleportRelative=function(a,b){var c=this;c.pose.theta=(c.pose.theta+b)%(2*Math.PI),c.pose.x+=-Math.sin(this.pose.theta)*a,c.pose.y+=-Math.cos(this.pose.theta)*a,this.update()};
